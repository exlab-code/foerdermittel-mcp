name: Update Fördermittel DB

on:
  schedule:
    # Every 2 days at 5:00 UTC (after CorrelAid's nightly update)
    - cron: '0 5 */2 * *'
  workflow_dispatch: # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore DB cache
        uses: actions/cache/restore@v4
        with:
          path: foerdermittel.db
          key: foerdermittel-db-dummy
          restore-keys: foerdermittel-db-

      - name: Run enrichment pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python enrich.py

      - name: Save DB cache
        uses: actions/cache/save@v4
        with:
          path: foerdermittel.db
          key: foerdermittel-db-${{ github.run_id }}

      - name: Publish DB as release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          TAG="db-${DATE}"

          # Delete existing release for today if re-running
          gh release delete "$TAG" --yes 2>/dev/null || true
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true

          git tag "$TAG"
          git push origin "$TAG"

          gh release create "$TAG" foerdermittel.db \
            --title "Fördermittel DB ${DATE}" \
            --notes "Automated database update ($(date -u +%Y-%m-%dT%H:%M:%SZ))" \
            --latest

      - name: Notify digikal to update
        if: success()
        env:
          GH_TOKEN: ${{ secrets.DIGIKAL_PAT }}
        run: |
          gh api repos/exlab-code/digikal/dispatches \
            -f event_type=foerdermittel-updated
